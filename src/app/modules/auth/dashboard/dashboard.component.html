 <!-- Backdrop for mobile sidebar -->
<div *ngIf="isMobileSidebarOpen" (click)="toggleMobileSidebar()" class="fixed inset-0 z-40 bg-black/60 lg:hidden"
     aria-hidden="true"></div>
<div *ngIf="user" class="flex min-h-screen w-full bg-gray-50">
    <!-- Sidebar -->
    <div class="sidebar-bg fixed inset-y-0 left-0 z-50 flex w-64 -translate-x-full transform flex-col text-white shadow-xl transition-transform duration-300 ease-in-out lg:relative lg:flex-shrink-0 lg:translate-x-0"
         [class.translate-x-0]="isMobileSidebarOpen">
<!-- Updated Logo and Tagline Section -->
    <div class="border-b border-white/20 p-6 text-center">
        <div class="inline-block rounded-3xl bg-white/10 p-4">
            <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcROTKn0j9cVpA67LPdjPeYBR3KnWiwP1gsM3cS27rca-7m8BgvgUylY4uhBnOnVnXFx8Is&usqp=CAU"
                 alt="Geminia Logo" class="h-20 w-auto" />
        </div>
        <p class="mt-3 text-sm font-semibold tracking-wide text-white/90">Think Insurance ... Think Geminia</p>
    </div>

    <div class="border-b border-white/20 p-6">
        <div class="flex items-center space-x-3">
            <div class="relative">
                <div
                    class="flex h-12 w-12 items-center justify-center rounded-full bg-white/20 ring-2 ring-white/30">
                    <span class="text-lg font-bold text-white">{{ getInitials(user.name) }}</span>
                </div>
                <div
                    class="absolute -bottom-1 -right-1 h-4 w-4 rounded-full border-2 border-pantone-dark-blue bg-pantone-light-blue">
                </div>
            </div>
            <div class="flex-1">
                <p class="text-sm font-medium text-white/90">Welcome back,</p>
                <h3 class="text-lg font-bold text-white">{{ user.name.split(' ')[0] }}</h3>
            </div>
        </div>
    </div>

    <nav class="flex-1 overflow-y-auto p-4">
        <div class="space-y-1">
            <ng-container *ngFor="let item of navigationItems">
                <ng-container *ngIf="!item.children">
                    <a *ngIf="item.route" [routerLink]="item.route" routerLinkActive="active-menu-item"
                       class="nav-menu-item group flex items-center space-x-3 rounded-xl px-4 py-3 text-white/80 transition-all hover:bg-white/10 hover:text-white">
                        <mat-icon class="sidebar-nav-icon">{{ item.icon }}</mat-icon>
                        <span class="font-medium">{{ item.label }}</span>
                    </a>
                    <a *ngIf="item.sectionId" (click)="scrollToSection(item.sectionId)"
                       class="nav-menu-item group flex cursor-pointer items-center space-x-3 rounded-xl px-4 py-3 text-white/80 transition-all hover:bg-white/10 hover:text-white">
                        <mat-icon class="sidebar-nav-icon">{{ item.icon }}</mat-icon>
                        <span class="font-medium">{{ item.label }}</span>
                    </a>
                </ng-container>

                <div *ngIf="item.children">
                    <button (click)="toggleNavItem(item)"
                            class="nav-menu-item group flex w-full items-center justify-between rounded-xl px-4 py-3 text-white/80 transition-all hover:bg-white/10 hover:text-white">
                        <div class="flex items-center space-x-3">
                            <mat-icon class="sidebar-nav-icon">{{ item.icon }}</mat-icon>
                            <span class="font-medium">{{ item.label }}</span>
                        </div>
                        <mat-icon class="sidebar-nav-icon transition-transform duration-200"
                                  [class.rotate-180]="item.isExpanded">expand_more</mat-icon>
                    </button>
                    <div *ngIf="item.isExpanded" class="mt-1 ml-6 space-y-1">
                        <a *ngFor="let child of item.children" [routerLink]="child.route" routerLinkActive="active-submenu-item"
                           class="block w-full rounded-lg px-4 py-2 text-left text-sm text-white/70 transition-colors hover:bg-white/10 hover:text-white">
                            <div class="flex items-center space-x-2">
                                <mat-icon class="sidebar-nav-icon !h-4 !w-4 !text-sm">{{ child.icon }}</mat-icon>
                                <span>{{ child.label }}</span>
                            </div>
                        </a>
                    </div>
                </div>
            </ng-container>
        </div>
    </nav>
</div>

<!-- Main Content -->
<div class="flex flex-1 flex-col overflow-x-hidden">
    <header class="border-b border-gray-200/50 bg-white px-4 py-3 shadow-sm sm:px-6">
        <div class="flex items-center justify-between gap-4">
            <div class="flex items-center space-x-2 sm:space-x-4">
                <button mat-icon-button (click)="toggleMobileSidebar()" class="text-gray-600 lg:hidden">
                    <mat-icon>menu</mat-icon>
                </button>
                <div>
                    <h1 class="text-xl font-bold tracking-tight text-pantone-dark-blue sm:text-2xl">Dashboard</h1>
                    <p class="mt-1 text-sm text-gray-600">Overview of your insurance portfolio</p>
                </div>
            </div>
            <div class="flex items-center space-x-3">
                <button mat-icon-button [matMenuTriggerFor]="notificationMenu"
                        class="relative text-pantone-light-blue">
                    <mat-icon>notifications</mat-icon>
                    <span *ngIf="getUnreadNotificationCount() > 0"
                          class="absolute -top-1 -right-1 flex h-5 w-5 items-center justify-center rounded-full bg-pantone-dark-blue text-xs font-bold text-white">{{
                            getUnreadNotificationCount() }}</span>
                </button>
                <button mat-icon-button [matMenuTriggerFor]="userMenu"
                        class="relative h-10 w-10 rounded-full bg-pantone-dark-blue text-white">
                    <span class="text-sm font-bold">{{ getInitials(user.name) }}</span>
                </button>
            </div>
        </div>
    </header>

    <main id="main-dashboard-area" class="flex-1 overflow-y-auto bg-gray-50 p-4 md:p-6">
        <!-- Stats Cards -->
        <div class="mb-8 grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-4">
            <div class="stats-card" *ngFor="let stat of [
                { title: 'Active Claims', value: dashboardStats.activeClaims, prefix: '' },
                { title: 'Marine Policies', value: totalPolicies, prefix: '' },
                { title: 'Pending Quotes', value: totalRecords, prefix: '' },
                { title: 'Total Premium', value: (dashboardStats.totalPremium | number: '1.0-0'), prefix: 'KES' }
            ]">
                <h3 class="mb-2 text-sm font-semibold uppercase tracking-wide text-gray-600">{{ stat.title }}</h3>
                <p class="text-3xl font-bold text-pantone-dark-blue">{{ stat.prefix }} {{ stat.value }}</p>
                <div class="mt-3 h-1 w-12 rounded-full bg-pantone-light-blue"></div>
            </div>
        </div>

        <div class="grid grid-cols-1 gap-8 lg:grid-cols-3">
            <div class="space-y-8 lg:col-span-2">

                <!-- ============================ SECTION ORDER CHANGE START ============================ -->

                <!-- 1. Saved Quotes Section -->
                <div id="saved-quotes-section" class="overflow-hidden rounded-2xl border border-gray-100 bg-white shadow-lg">
                    <div class="bg-pantone-dark-blue px-6 py-4 text-white">
                        <h3 class="flex items-center text-xl font-bold">
                            <mat-icon class="mr-2">pending_actions</mat-icon>Saved Quotes
                        </h3>
                    </div>
                    <div class="p-6">
                        <div *ngIf="pendingQuotes.length > 0; else noQuotes"
                             class="grid grid-cols-1 gap-6 md:grid-cols-2">

                            <div *ngFor="let quote of pendingQuotes; let i = index"
                                 class="quote-card group flex flex-col rounded-xl border border-gray-200 bg-gray-50 p-6">
                                <div class="flex-grow">
                                    <p class="text-xs text-gray-500">Ref No: {{ quote.refno }}</p>
                                    <div class="mb-4 flex items-center justify-between">
                                      <span class="rounded-full px-3 py-1 text-xs font-semibold uppercase tracking-wide text-white"
                                            [ngClass]="{
                                              'bg-amber-500': quote.status === 'PAID',
                                              'bg-yellow-500': quote.status === 'DRAFT',
                                              'bg-green-600': quote.status === 'FINAL',
                                              'bg-blue-600': quote.status === 'PROCESSING'
                                            }">
                                        {{ quote.status === 'PAID' ? 'PROCESSING...' : quote.status }}
                                      </span>

                                        <p class="text-xs text-gray-500">
                                            Created: {{ quote.createDate | date: 'shortDate' }}
                                        </p>
                                    </div>

                                    <h4 class="mb-2 truncate text-lg font-bold text-pantone-dark-blue" [title]="quote.prodName">{{ quote.prodName }}</h4>
                                    <p class="line-clamp-2 mb-4 text-sm text-gray-600" [title]="quote.description">
                                        {{ quote.description }}
                                    </p>

                                    <div class="mb-6 flex items-center justify-between">
                                        <div class="text-2xl font-bold text-pantone-dark-blue">
                                            KES {{ quote.netprem | number: '1.0-0' }}
                                        </div>
                                    </div>
                                </div>

                                <!-- Button container with proper spacing to prevent overlap -->
                                <div class="mt-auto flex items-stretch justify-end gap-1.5" *ngIf="showOption(quote.status)">
                                    <button mat-stroked-button color="warn" (click)="deleteQuote(quote.id, i)"
                                            class="flex items-center justify-center rounded-xl !border-red-400 px-2.5 py-1.5 text-xs font-medium !text-red-500 transition-colors hover:bg-red-50 whitespace-nowrap">
                                        <mat-icon class="!h-4 !w-4">delete_outline</mat-icon>
                                        <span class="hidden sm:inline ml-1">Delete</span>
                                    </button>
                                    <button mat-stroked-button [routerLink]="['/marine-quote']"
                                            [queryParams]="{ editId: quote.id }"
                                            class="flex items-center justify-center rounded-xl !border-pantone-light-blue px-2.5 py-1.5 text-xs font-medium !text-pantone-light-blue transition-colors hover:bg-blue-50 whitespace-nowrap">
                                        <mat-icon class="!h-4 !w-4">edit</mat-icon>
                                        <span class="hidden sm:inline ml-1">Edit</span>
                                    </button>
                                    <button mat-raised-button (click)="initiatePayment(quote.quoteId,quote.originCountry,quote.shippingmodeId,quote.sumassured,quote.pinNumber,quote.idNumber,quote.status,quote.phoneNo,quote.netprem,quote.refno)"
                                            class="flex items-center justify-center rounded-xl bg-pantone-dark-blue px-3 py-1.5 text-xs font-medium text-white whitespace-nowrap">
                                        <mat-icon class="!h-4 !w-4">credit_card</mat-icon>
                                        <span class="ml-1">Pay Now</span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Pagination controls -->
                        <div class="mt-6 flex justify-center space-x-4" *ngIf="pendingQuotes.length > 0">
                            <button mat-stroked-button (click)="prevPage()" [disabled]="page === 0">Previous</button>
                            <span class="px-2 py-1 text-sm">Page {{ page + 1 }} of {{ Math.ceil(totalRecords / pageSize) }}</span>
                            <button mat-stroked-button (click)="nextPage()" [disabled]="(page + 1) * pageSize >= totalRecords">Next</button>
                        </div>
                        <ng-template #noQuotes>
                            <p class="py-8 text-center text-gray-500">You have no saved quotes. Start a new one and it will appear here!</p>
                        </ng-template>
                    </div>
                </div>

                <!-- 2. Active Policies Section -->
                <div id="my-policies-section" class="overflow-hidden rounded-2xl border border-gray-100 bg-white shadow-lg">
                    <div class="bg-pantone-light-blue px-6 py-4 text-white">
                        <h2 class="flex items-center text-xl font-bold">
                            <mat-icon class="mr-2">shield</mat-icon>Active Policies
                        </h2>
                    </div>
                    <div class="p-6">
                         <!-- Search Input for Policies -->
                        <div class="mb-6">
                            <mat-form-field appearance="outline" class="w-full md:max-w-sm compact-search-bar">
                                <mat-label>Search Active Policies</mat-label>
                                <input matInput [(ngModel)]="policySearchTerm" (input)="applyPolicyFilter()"
                                       placeholder="e.g., Policy No, Vessel Name...">
                                <mat-icon matSuffix>search</mat-icon>
                            </mat-form-field>
                        </div>

                        <div *ngIf="filteredPolicies.length > 0; else noPoliciesFound" class="space-y-4">
                            <!-- Loop over filteredPolicies -->
                            <div *ngFor="let policy of filteredPolicies" class="policy-card group overflow-hidden rounded-xl border border-gray-200">
                                <div class="flex cursor-pointer items-center justify-between p-4" (click)="togglePolicyDetails(policy.id)">
                                    <div class="flex items-center space-x-4">
                                        <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-pantone-light-blue/10">
                                            <mat-icon class="text-pantone-light-blue">{{ 'directions_boat'}}</mat-icon>
                                        </div>
                                        <div>
                                            <h4 class="text-lg font-bold text-pantone-dark-blue">{{ policy.refno }}</h4>
                                            <p class="text-sm text-gray-600">{{ policy.erprefno }}</p>
                                        </div>
                                        <div>
                                            <h4 class="text-lg font-bold text-pantone-dark-blue">KES: {{policy.netpremium | number: '1.2-2' }}</h4>
                                        </div>
                                    </div>
                                </div>
                                <div class="policy-details-collapsible" [class.expanded]="expandedPolicyId === policy.id">
                                    <div class="px-6 pt-2 pb-4">
                                            <h4 class="detail-section-title">Shipment Details</h4>
                                            <div class="policy-detail-grid">
                                                <div class="detail-item"><span class="detail-label">Mode of Shipment</span><span class="detail-value">{{ policy.shippingModeName | titlecase }}</span></div>
                                                <div class="detail-item"><span class="detail-label">Trade Type</span><span class="detail-value">{{ policy.importerType | titlecase }}</span></div>
                                                <div class="detail-item"><span class="detail-label">Vessel Name</span><span class="detail-value">{{ policy.vesselName }}</span></div>
                                                <div class="detail-item"><span class="detail-label">Country of Origin</span><span class="detail-value">{{ policy.originPortName }}</span></div>
                                                <div class="detail-item"><span class="detail-label">Destination</span><span class="detail-value">{{ policy.destPortName }}</span></div>
                                                <div class="detail-item"><span class="detail-label">UCR Number</span><span class="detail-value">{{ policy.ucrNumber }}</span></div>
                                            </div>
                                        <div class="mt-6 flex items-center justify-between border-t pt-4">
                                            <button mat-stroked-button (click)="openClaimModal(policy)" class="file-claim-button">
                                                <mat-icon>assignment_late</mat-icon> File a Claim
                                            </button>
                                            <button mat-raised-button (click)="downloadCertificate(policy.id)" class="rounded-xl bg-pantone-dark-blue px-6 py-2 text-sm font-semibold text-white">Download Certificate</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Message for no search results or no policies -->
                        <ng-template #noPoliciesFound>
                            <p class="py-8 text-center text-gray-500">
                              {{ policySearchTerm ? 'No policies found matching "' + policySearchTerm + '".' : 'You have no active policies.' }}
                            </p>
                        </ng-template>

                        <div *ngIf="toastMessage" class="animate-fade-in-out fixed bottom-5 right-5 z-50 rounded-lg bg-gray-800 px-5 py-3 text-white shadow-lg transition-opacity duration-300">{{ toastMessage }}</div>


                        <!-- Pagination controls (hidden during search) -->
                        <div class="text-center mt-8 flex justify-center space-x-4" *ngIf="totalPolicies > 0 && !policySearchTerm">
                            <button mat-stroked-button color="warn" (click)="loadLess()" *ngIf="hasLess()" class="px-6 py-2 text-sm font-semibold rounded-xl">
                                <mat-icon>expand_less</mat-icon> Load Less
                            </button>
                            <button mat-raised-button color="primary" (click)="loadMore()" *ngIf="hasMore()" class="px-6 py-2 text-sm font-semibold rounded-xl">
                                <mat-icon>expand_more</mat-icon> Load More
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 3. My Claims Section -->
                <div id="my-claims-section" *ngIf="claims.length > 0" class="overflow-hidden rounded-2xl border border-gray-100 bg-white shadow-lg">
                    <div class="bg-pantone-dark-blue px-6 py-4 text-white">
                        <h2 class="flex items-center text-xl font-bold">
                            <mat-icon class="mr-2">assignment_late</mat-icon>My Claims
                        </h2>
                    </div>
                    <div class="p-6">
                        <!-- Search Input for Claims -->
                        <div class="mb-6">
                            <mat-form-field appearance="outline" class="w-full md:max-w-sm compact-search-bar">
                                <mat-label>Search My Claims</mat-label>
                                <input matInput [(ngModel)]="claimSearchTerm" (input)="applyClaimFilter()"
                                       placeholder="e.g., Claim No, Policy No, Status...">
                                <mat-icon matSuffix>search</mat-icon>
                            </mat-form-field>
                        </div>

                        <div *ngIf="filteredClaims.length > 0; else noClaimsFound" class="space-y-4">
                            <!-- Loop over filteredClaims -->
                            <div *ngFor="let claim of filteredClaims" class="policy-card group overflow-hidden rounded-xl border border-gray-200">
                                <div class="flex cursor-pointer items-center justify-between p-4" (click)="toggleClaimDetails(claim.id)">
                                    <div class="flex items-center space-x-4">
                                        <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-pantone-light-blue/10">
                                            <mat-icon class="text-pantone-light-blue">assignment_late</mat-icon>
                                        </div>
                                        <div>
                                            <h4 class="text-lg font-bold text-pantone-dark-blue">{{ claim.claimNumber }}</h4>
                                            <p class="text-sm text-gray-600">Policy: {{ claim.policyNumber }}</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-4">
                                        <div class="claim-status-chip" [ngClass]="getClaimStatusClass(claim.status)">{{ claim.status }}</div>
                                        <mat-icon class="text-gray-400 transition-transform" [class.rotate-180]="expandedClaimId === claim.id">expand_more</mat-icon>
                                    </div>
                                </div>
                                <div class="policy-details-collapsible" [class.expanded]="expandedClaimId === claim.id">
                                    <div class="px-6 pt-2 pb-4">
                                        <h4 class="detail-section-title">Claim Details</h4>
                                        <div class="policy-detail-grid">
                                            <div class="detail-item"><span class="detail-label">Date of Loss</span><span class="detail-value">{{ claim.dateOfLoss | date:'mediumDate' }}</span></div>
                                            <div class="detail-item"><span class="detail-label">Type of Loss</span><span class="detail-value">{{ claim.typeOfLoss }}</span></div>
                                            <div class="detail-item"><span class="detail-label">Estimated Loss</span><span class="detail-value">KES {{ claim.estimatedLoss | number:'1.2-2' }}</span></div>
                                            <div class="detail-item"><span class="detail-label">Date Submitted</span><span class="detail-value">{{ claim.submittedDate | date:'mediumDate' }}</span></div>
                                        </div>
                                        <div class="detail-item-full"><span class="detail-label">Description of Incident</span><span class="detail-value">{{ claim.description }}</span></div>
                                        <h4 class="detail-section-title">Submitted Documents</h4>
                                        <div *ngIf="claim.documents.length > 0; else noDocuments" class="space-y-2">
                                            <div *ngFor="let doc of claim.documents" class="flex items-center rounded-md bg-gray-100 p-2">
                                                <mat-icon class="mr-2 text-gray-500">description</mat-icon>
                                                <span class="text-sm font-medium text-pantone-dark-blue">{{ doc.name }}</span>
                                                <span class="ml-auto text-xs text-gray-500">({{ doc.size / 1024 | number:'1.0-0' }} KB)</span>
                                            </div>
                                        </div>
                                        <ng-template #noDocuments><p class="text-sm text-gray-500">No documents were submitted with this claim.</p></ng-template>
                                    </div>
                                </div>
                            </div>
                        </div>
                         <!-- Message for no search results or no claims -->
                        <ng-template #noClaimsFound>
                            <p class="py-8 text-center text-gray-500">
                              {{ claimSearchTerm ? 'No claims found matching "' + claimSearchTerm + '".' : 'You have no registered claims.' }}
                            </p>
                        </ng-template>
                    </div>
                </div>

                <!-- ============================ SECTION ORDER CHANGE END ============================ -->

            </div>

            <!-- Right Column -->
            <div class="space-y-6">
                <div class="overflow-hidden rounded-2xl border border-gray-100 bg-white shadow-lg">
                    <div class="bg-pantone-light-blue px-6 py-4 text-white"><h3 class="text-lg font-bold">Quick Actions</h3></div>
                    <div class="space-y-4 p-6">
                        <button mat-raised-button [routerLink]="['/marine-quote']" class="w-full rounded-xl bg-pantone-dark-blue p-4 text-sm font-semibold text-white">New Marine Quote</button>
                    </div>
                </div>
                <div class="overflow-hidden rounded-2xl border border-gray-100 bg-white shadow-lg">
                    <div class="bg-pantone-dark-blue px-6 py-4 text-white"><h3 class="text-lg font-bold">Recent Activity</h3></div>
                    <div class="p-6">
                        <div class="max-h-80 space-y-4 overflow-y-auto">
                            <div *ngFor="let activity of recentActivities" class="activity-item group flex cursor-pointer items-start space-x-3 rounded-lg p-3 hover:bg-gray-50">
                                <div class="flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-full" [style.background-color]="activity.iconColor + '20'">
                                    <mat-icon class="!text-base" [style.color]="activity.iconColor">{{ activity.icon }}</mat-icon>
                                </div>
                                <div class="min-w-0 flex-1">
                                    <p class="truncate text-sm font-semibold text-pantone-dark-blue">{{ activity.title }}</p>
                                    <p class="truncate text-xs text-gray-500">{{ activity.description }}</p>
                                    <p class="mt-1 text-xs text-gray-400">{{ activity.timestamp | date:'short' }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>
</div>
<!-- Menus -->
<mat-menu #notificationMenu="matMenu">
<div class="border-b border-gray-100 px-4 py-3">
<h3 class="font-semibold text-pantone-dark-blue">Notifications</h3>
</div>
<button mat-menu-item *ngFor="let notification of notifications" (click)="markNotificationAsRead(notification)" class="!min-w-[350px] !whitespace-normal px-4 py-3 hover:bg-gray-50">
<div class="flex items-start space-x-3">
<div class="mt-2 h-2 w-2 flex-shrink-0 rounded-full" [ngClass]="{'bg-pantone-dark-blue': !notification.read, 'bg-gray-300': notification.read}"></div>
<div class="min-w-0 flex-1">
<p class="text-sm font-semibold text-pantone-dark-blue">{{ notification.title }}</p>
<p class="break-words text-sm text-gray-600">{{ notification.message }}</p>
<p class="mt-1 text-xs text-gray-500">{{ notification.timestamp | date:'short' }}</p>
</div>
</div>
</button>
</mat-menu>
<mat-menu #userMenu="matMenu">
<div class="border-b border-gray-100 px-4 py-3">
<p class="font-semibold text-pantone-dark-blue">{{ user?.name }}</p>
<p class="text-sm text-gray-500">{{ user?.email }}</p>
</div>
<button mat-menu-item (click)="router.navigate(['/profile'])" class="px-4 py-3 hover:bg-gray-50">
<mat-icon class="mr-3 text-gray-600">person</mat-icon><span>Profile</span>
</button>
<button mat-menu-item (click)="logout()" class="px-4 py-3 hover:bg-gray-50">
<mat-icon class="mr-3 text-gray-600">logout</mat-icon><span>Logout</span>
</button>
</mat-menu>
